# task-009-mikrotik-config-diff.md

## Мета
Додати механізм перевірки змін конфігурації для MikroTik шляхом порівняння **останнього export** з **попереднім**, щоб визначати, чи відбулися зміни, та за потреби формувати diff.

Механізм має бути стійким до «шуму» (пробіли, коментарі, порядок рядків) і не генерувати хибні спрацювання.

---

## Загальна ідея
Для кожного бекапу MikroTik необхідно працювати з двома представленнями конфігурації:
1. **Raw export** – оригінальний результат `/export`
2. **Normalized export** – нормалізована версія для коректного порівняння

Порівняння виконується **по normalized-версії**, а raw зберігається як первинний артефакт.

---

## Вхідні дані
- Поточний export, отриманий у task-007
- Попередній export з директорії:
```
<BACKUP_DIR>/mikrotik/<device_name>/
```

---

## Вимоги

### 1) Пошук попереднього бекапу
Для кожного MikroTik-пристрою:
- зчитати всі файли `*_export.rsc` у директорії пристрою
- відсортувати за часом (по timestamp в імені файлу або mtime)
- визначити:
  - `current` – щойно створений export
  - `previous` – попередній export (якщо існує)

Якщо `previous` відсутній:
- вважати це першим бекапом
- diff не виконується

---

### 2) Нормалізація конфігурації
Перед порівнянням виконати нормалізацію тексту export:

Мінімальні правила нормалізації:
- обрізати пробіли на початку та в кінці рядків
- видалити порожні рядки
- видалити коментарі (рядки, що починаються з `#`)
- звести множинні пробіли до одного

Нормалізований текст може:
- зберігатися у файлі поруч з raw
- або використовуватись лише в памʼяті (на вибір реалізації)

---

### 3) Перевірка змін (hash)
Для normalized-версії:
- обчислити `sha256`
- порівняти hash поточного та попереднього export

Правила:
- якщо hash однаковий – зміни відсутні
- якщо hash різний – конфігурація змінилась

---

### 4) Формування diff
Якщо виявлено зміни:
- згенерувати unified diff (аналог `git diff`)
- порахувати:
  - кількість доданих рядків
  - кількість видалених рядків

Diff:
- логувати **лише summary**
- за потреби зберігати у файл:
```
<BACKUP_DIR>/mikrotik/<device_name>/YYYY-mm-dd_HHMMSS_export.diff
```

---

### 5) Логування
Для кожного пристрою логувати:

- `INFO first_backup=true` – якщо попереднього export немає
- `INFO config_changed=false` – якщо hash не змінився
- `INFO config_changed=true` – якщо виявлено зміни
- `DEBUG diff added=<N> removed=<M>`
- `INFO diff_saved=<path>` – якщо diff збережено у файл

Конфігурація або її фрагменти **не повинні** потрапляти у лог.

---

## Реалізація в коді

### Рекомендовані файли
- `src/app/mikrotik/diff.py`
  - нормалізація
  - hash
  - diff
- (оновити) `src/app/mikrotik/backup.py`
  - виклик diff-перевірки після збереження export
- (опційно) `src/app/core/storage.py`
  - пошук попередніх файлів

### Рекомендовані функції
```python
def normalize_export(text: str) -> str:
    ...

def calculate_hash(text: str) -> str:
    ...

def generate_diff(prev: str, curr: str) -> tuple[str, int, int]:
    ...
```

---

## Acceptance criteria
- Для першого бекапу diff не виконується
- Для наступних бекапів:
  - коректно визначається наявність/відсутність змін
  - відсутні хибні спрацювання через пробіли/коментарі
- При зміні конфігу:
  - формується diff
  - у логах є summary
- Raw export завжди зберігається
- Секрети та конфіг не потрапляють у логи

---

## Результат
NetConfigBackup може автоматично визначати зміни конфігурації MikroTik, відокремлюючи реальні зміни від шуму, та надавати зрозумілу інформацію для аудиту і контролю змін.
