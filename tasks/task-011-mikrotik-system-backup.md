# task-011-mikrotik-system-backup.md

## Мета
Додати підтримку **бінарного бекапу MikroTik** через команду  
`/system backup save` як додатковий тип бекапу поряд із текстовим `/export`.

Бінарний бекап призначений для **disaster recovery** і не використовується для diff або аналізу змін.

---

## Контекст
У попередніх задачах реалізовано:
- текстовий бекап `/export`
- нормалізацію та diff для контролю змін
- керування BACKUP_DIR
- DEBUG-режим та логування

Бінарний backup:
- не придатний для diff
- може бути привʼязаний до версії RouterOS та апаратної платформи
- але є корисним для швидкого відновлення конфігурації

---

## Вимоги

### 1) Команда бінарного бекапу
Для MikroTik необхідно виконувати команду:

```
/system backup save name=<filename> dont-encrypt=yes
```

Вимоги:
- `name` формується з timestamp
- `dont-encrypt=yes` (щоб не вимагати пароль при restore)
- команда виконується **після успішного /export**

---

### 2) Отримання файлу з пристрою
Після виконання `/system backup save`:
- файл зʼявляється на MikroTik (`<filename>.backup`)
- необхідно завантажити його на локальну машину

Дозволені способи:
- SFTP (рекомендовано)
- SCP

Вимоги:
- використовувати ті самі облікові дані, що і для SSH
- перевірити, що файл існує та має ненульовий розмір

---

### 3) Збереження в BACKUP_DIR
Бінарний бекап зберігається у:

```
<BACKUP_DIR>/mikrotik/<device_name>/
```

Формат імені файлу:
```
YYYY-mm-dd_HHMMSS_system.backup
```

Текстовий export і binary backup зберігаються поруч, але як **різні типи файлів**.

---

### 4) Обмеження
- Бінарний backup **НЕ**:
  - нормалізується
  - diff-иться
  - аналізується
- Він зберігається лише як артефакт для відновлення

---

### 5) Логування
Логувати (мінімум):

- старт binary backup:
  - `INFO start system-backup device=<name>`
- успішне створення backup на пристрої:
  - `DEBUG system-backup created on device file=<filename>`
- успішне завантаження:
  - `INFO system-backup saved path=<full_path> size=<bytes>`
- помилки:
  - відсутній файл
  - помилка завантаження
  - permission denied

Паролі та секрети **не логувати**.

---

## Реалізація в коді

### Орієнтовні файли
- `src/app/mikrotik/backup.py`
  - виклик `/system backup save`
- `src/app/mikrotik/client.py`
  - SFTP/SCP download
- (оновити) `scripts/run.py`
  - запуск binary backup після `/export`
- (за потреби) `src/app/core/storage.py`
  - допоміжні функції для шляхів

---

## Acceptance criteria
- Для кожного `vendor: mikrotik`:
  - виконується `/export`
  - виконується `/system backup save`
- Бінарний файл:
  - реально завантажується з пристрою
  - має ненульовий розмір
  - зберігається у правильній директорії
- При помилці binary backup:
  - export не втрачається
  - помилка коректно логується
- Бінарний backup не впливає на diff-логіку

---

## Результат
NetConfigBackup підтримує **два типи бекапів MikroTik**:
- текстовий (`/export`) для аудиту та контролю змін
- бінарний (`/system backup save`) для аварійного відновлення
