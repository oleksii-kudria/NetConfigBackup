# task-028-dry-run-mode.md

## Мета
Додати **dry-run режим** у `scripts/run.py`, який запускає NetConfigBackup у режимі перевірки:

- проходить всі основні кроки pipeline (зчитування конфігів, перевірки, підключення)
- перевіряє доступність пристроїв і автентифікацію (SSH login)
- **не виконує команди отримання бекапу**
- **не зберігає файли бекапів** локально
- не змінює стан пристроїв

Dry-run потрібен для швидкої валідації доступу та конфігурації без створення артефактів.

---

## Нова CLI опція
Додати опцію:

- `--dry-run` (boolean flag)

Вона має відображатись у `scripts/run.py --help`.

---

## Очікувана поведінка

### 1) Загальна логіка
У режимі `--dry-run`:

- завантажити `devices.yml` та `secrets.yml`
- виконати валідацію конфігів
- для кожного пристрою виконати:
  - перевірку TCP доступності (ip:port)
  - встановлення SSH-зʼєднання
  - (Cisco) виконання enable (якщо увімкнено/доступно) - без запуску команд backup
  - (Cisco) disable paging (опційно) - допускається як етап підготовки, але краще пропустити, якщо трактувати як non-backup команду

Ключова вимога:
- НЕ виконувати команд, які повертають/формують backup:
  - MikroTik: не виконувати `/export`, не виконувати `/system backup save`
  - Cisco: не виконувати `show running-config`

---

### 2) Взаємодія з feature flags (task-027)
Dry-run повинен працювати незалежно від того, які feature flags задані:

- якщо вказані feature flags - dry-run перевіряє лише ті вендори/підзадачі, що були б запущені
- якщо флаги не задані - dry-run повторює дефолтний вибір задач, але без виконання backup-команд

---

### 3) Збереження файлів
У dry-run:
- не створювати директорії backup (не створювати `<BACKUP_DIR>/...`)
- не створювати файли
- не виконувати sanity-check файлів (бо файлів немає)

---

### 4) Логування
На старті:
- INFO: `dry_run=true`

Для кожного пристрою:
- INFO: `device=<name> vendor=<vendor> dry_run connection-check start`
- INFO: `device=<name> ssh connected`
- INFO: `device=<name> dry_run skipping backup commands`

У випадку помилок:
- ERROR як і в звичайному режимі (unreachable, auth failed тощо)

---

### 5) Вивід підсумку
Після завершення run:
- INFO: загальна статистика:
  - кількість пристроїв перевірено
  - скільки успішно підключено
  - скільки з помилками доступу/автентифікації
  - dry-run підтвердження, що backup-команди не виконувались

---

## Вимоги до реалізації

### 1) Архітектура
Dry-run має бути реалізований як параметр керування виконанням pipeline, щоб:
- мінімізувати дублювання коду
- усі підзадачі отримували контекст `dry_run`

Можливі підходи:
- передавати `dry_run` у функції backup і робити early-exit перед виконанням команд
- або маршрутизувати виконання в `run.py` (не викликати backup-функції взагалі)

Рекомендація:
- у `run.py` не викликати функції, що виконують backup-команди, якщо `dry_run=true`.

---

### 2) Документація (README.md)
Оновити README.md (UA + EN, якщо використовується двомовність):
- описати `--dry-run`
- навести приклад:
  - `scripts/run.py --dry-run backup`
  - `scripts/run.py --dry-run --cisco-running-config backup`
- пояснити, що dry-run:
  - перевіряє доступ
  - не знімає конфіги
  - не створює файли

---

## Область змін
- `scripts/run.py` (argparse: `--dry-run`, логіка pipeline)
- модулі mikrotik/cisco backup (за потреби, якщо треба додати guard)
- `README.md`

---

## Acceptance criteria
- `scripts/run.py --help` містить `--dry-run`
- У dry-run виконується:
  - load configs
  - reachability check
  - SSH login
- У dry-run НЕ виконується:
  - `/export`
  - `/system backup save`
  - `show running-config`
  - будь-яке створення/запис backup-файлів
- Логи явно показують dry-run режим і пропуск backup-команд
- README.md оновлено

---

## Результат
NetConfigBackup підтримує dry-run режим для безпечної перевірки доступності та коректності налаштувань без створення бекапів і без змін на пристроях.
