# task-018-fix-mikrotik-filename-normalization-before-remove.md

## Мета
Виправити проблему видалення файлів на MikroTik, яка виникає при використанні
імен файлів, сформованих зі змінних, шляхом **нормалізації значення filename**
перед формуванням команди `/file remove`.

---

## Контекст
Було виявлено, що:

- команда з **хардкодженим іменем файлу** працює:
```
/file remove petrov-mikrotik_2025-12-28_124045.backup
```

- але команда зі змінною **не видаляє файл**:
```python
command = f'/file remove "{filename}"'
```

При цьому помилок у логах RouterOS немає, а команда виконується «тихо».

---

## Причина
Змінна `filename` може містити:
- пробіли на початку або в кінці
- символи переводу рядка (`\n`, `\r`)
- зайві лапки
- тип `Path` або інший обʼєкт, не приведений до чистого `str`

RouterOS CLI виконує **строге порівняння імені файлу**, тому навіть один зайвий
символ призводить до того, що файл не знаходиться і не видаляється.

---

## Рішення

### 1) Нормалізація filename
Перед використанням `filename` у будь-яких RouterOS командах необхідно виконати:

```python
filename = str(filename).strip().strip('"')
```

Це обовʼязкова операція.

---

### 2) Видалення файлу
Після нормалізації використовувати **безпечний і стабільний варіант**:

```python
command = f'/file remove [find name="{filename}"]'
```

❌ Заборонено використовувати:
```python
/file remove "{filename}"
```

---

### 3) Логування (DEBUG)
Для діагностики додати DEBUG-лог з використанням `repr`:

```python
logger.debug("remote filename repr=%r", filename, extra=log_extra)
```

Це дозволяє виявляти приховані символи у випадку повторення проблеми.

---

## Область змін
Перевірити та оновити:

- `src/app/mikrotik/client.py`
- `src/app/mikrotik/backup.py`
- будь-які helper-функції, де використовується `filename` для RouterOS команд

---

## Acceptance criteria
- Перед виконанням `/file remove` імʼя файлу нормалізується
- Видалення працює як для хардкоджених імен, так і для імен зі змінних
- Використовується лише `/file remove [find name="..."]`
- DEBUG-лог з `repr(filename)` присутній (або легко вмикається)
- Cleanup більше не залежить від «невидимих» символів

---

## Результат
NetConfigBackup стабільно видаляє binary backup-файли з MikroTik незалежно від
джерела формування імені файлу, усуваючи silent-failure сценарії.
